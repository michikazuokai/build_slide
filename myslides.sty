%=================================================================
% myslides.sty - 共通スライド用スタイル（minted既定 / listingsに切替可）
%=================================================================
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{myslides}[2025/09/01 Common slide utilities]
\RequirePackage{xparse} % 先頭のほうで一度だけ
%----------------- オプション処理：minted(既定) / listings -----------------
\newif\ifmyslides@minted
\DeclareOption{minted}{\myslides@mintedtrue}
\DeclareOption{listings}{\myslides@mintedfalse}
\ExecuteOptions{minted} % 既定は minted
\ProcessOptions\relax

%----------------- 必要パッケージ（共通） -----------------
\RequirePackage{luatexja}        % LuaLaTeX想定
\RequirePackage{xcolor}
\RequirePackage{graphicx}
\RequirePackage{array}
\RequirePackage{tabularx}
\RequirePackage{booktabs}
\RequirePackage{makecell}
\RequirePackage{longtable}
\RequirePackage{mathtools}
\RequirePackage{setspace}
\RequirePackage{tikz}
\RequirePackage{url}
\RequirePackage{enumitem}
\RequirePackage[most]{tcolorbox}

%----------------- 色定義 -----------------
\definecolor{ok}{HTML}{2E7D32}
\definecolor{warn}{HTML}{EF6C00}
\definecolor{info}{HTML}{1565C0}
\definecolor{myDarkBlue}{RGB}{13,38,88}
\definecolor{myblue}{HTML}{E5F1F9}
\definecolor{myred}{HTML}{B02418}

%----------------- 表の列型 -----------------
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{M}[1]{>{\raggedright\arraybackslash}m{#1}}

%----------------- 箇条書きデフォルト -----------------
\setlist[itemize]{itemsep=0.4ex, topsep=0.4ex}
\setlist[enumerate]{itemsep=0.4ex, topsep=0.4ex}

%----------------- フッター共通 -----------------
\newcommand{\myfootertext}{@@footer@@}
\setbeamertemplate{footline}{
  \leavevmode
  \hbox to \paperwidth{
    \hspace*{0.2cm}
    \scriptsize\color{gray!50} \myfootertext
    \hfill
    \scriptsize\color{gray} \insertframenumber{} / \inserttotalframenumber
    \hspace*{0.4cm}
  }\vspace{1pt}
}

%----------------- セクション開始ページ -----------------
\AtBeginSection[]{
  \begin{frame}[plain]
    \vfill
    \rule{\textwidth}{2pt}
    \begin{center}{\color{myDarkBlue}\Huge \textbf{\insertsection}}\end{center}
    \rule{\textwidth}{2pt}
    \vfill
  \end{frame}
}

%----------------- TeacherFrame 環境 -----------------
\newif\ifteachermode
% 外部で \teachermodetrue / \teachermodefalse で切替

\newenvironment{TeacherFrame}[2][]{%
  \ifteachermode
    \begingroup
      \setbeamercolor{frametitle}{bg=myblue,fg=black}%
      \begin{frame}[t,allowframebreaks,#1]%
        \frametitle{\textbf{\textcolor{myred}{#2}}}%
}{%
      \end{frame}%
    \endgroup
  \fi
}

%----------------- pause制御 (mypause) -----------------
\newif\ifmypausemode
% 外部で \mypausemodetrue / \mypausemodefalse

\newcommand{\mypause}{%
  \ifmypausemode
    \pause
  \fi
}

%----------------- コード表示：minted または listings で実装 -----------------

% tcolorbox の共通外観
\tcbset{
  mycode/.style={
    colback=blue!5, colframe=blue!70!black,
    arc=1mm, boxrule=0.8pt,
    left=2mm, right=2mm, top=1mm, bottom=1mm,
    breakable
  }
}

\ifmyslides@minted
  % ===== minted 版 ===================================================
  \RequirePackage{minted} % ※ -shell-escape が必要
  \setminted{
    fontsize=\footnotesize,
    breaklines=true,
    frame=single
  }

  % インラインコード
  \newcommand{\inlinecode}[2][]{\mintinline[#1]{text}{#2}}

  % 複数行コード（lang必須）
  \newenvironment{codeblock}[1]{%
    \VerbatimEnvironment
    \begin{tcolorbox}[mycode]
    \begin{minted}{#1}
  }{%
    \end{minted}
    \end{tcolorbox}
  }

  % 外部ファイル読み込み（lang必須）
  \newcommand{\codefile}[2][]{%
    \begin{tcolorbox}[mycode]
      \inputminted[#1]{text}{#2}%
    \end{tcolorbox}
  }

\else
  % ===== listings 版 =================================================
  \RequirePackage{listings}
  \lstset{
    basicstyle=\ttfamily\footnotesize,
    frame=single,
    breaklines=true,
    showstringspaces=false,
    tabsize=2,
    xleftmargin=0pt
  }

  % インラインコード
  \newcommand{\inlinecode}[1]{\texttt{#1}}

  % 複数行コード（lang必須：例 python, bash）
  \newenvironment{codeblock}[1]{%
    \begin{tcolorbox}[mycode]
    \lstset{language=#1}%
    \begin{lstlisting}
  }{%
    \end{lstlisting}
    \end{tcolorbox}
  }

  % 外部ファイル読み込み
  \newcommand{\codefile}[2][]{%
    \begin{tcolorbox}[mycode]
      \lstinputlisting[#1]{#2}%
    \end{tcolorbox}
  }
\fi

% 通し番号カウンタ
\newcounter{framenum}

% 使い方: \begin{numframe}[<frameオプション>]{<タイトル>} ... \end{numframe}
\NewDocumentEnvironment{numframe}{O{} m}{%
  \stepcounter{framenum}%
  \begin{frame}[#1]{\theframenum.\, #2}%
}{%
  \end{frame}%
}

\endinput
